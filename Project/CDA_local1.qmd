---
title: "Prototype - Confirmatory Data Analysis"
date: "22 February 2024"
date-modified: "last-modified"
execute: 
  eval: true
  echo: true
  warning: false
---

```{r}
#| eval: false
#| echo: false
# colour
"#1F5776"
"#FB3640"
"#E9E3E6"
"grey20"
```

## Install and launch R packages

```{r}
#| code-fold: true     
#| code-summary: "Show code"  
pacman::p_load(visNetwork, # network graph
               GGally, parallelPlot, # parallel coordinates
               MASS, ggalluvial, # parallel coordinates
               tidyverse, leaflet, treemap, rmarkdown, highcharter, viridis,
               ggplot2, tidyr, dplyr, viridisLite, RColorBrewer, countrycode, 
               wordcloud, tidytext, # word cloud
               ggstatsplot, # statistical testing
               tm, plotly)
```

## Importing the Dataset

```{r message=F,warning=F}
#| code-fold: true    
#| code-summary: "Show code" 
GTD <- read.csv("data/data_filtered_analysis.csv")
```

## Text Analysis

### Word Cloud - Terrorist(s) Target

#### Is there a shift in interest of terrorist groups after 11 September 2001?

```{r}
createWordCloud <- function(year) {
  subset_data <- GTD %>%
    filter(motive != "", iyear == year)
  
  docs <- Corpus(VectorSource(subset_data$motive))
  docs <- tm_map(docs, removeNumbers)
  docs <- tm_map(docs, removeWords, stopwords("english"))
  docs <- tm_map(docs, removePunctuation)
  docs <- tm_map(docs, stripWhitespace)
  docs <- tm_map(docs, stemDocument)
  
  dtm <- TermDocumentMatrix(docs)
  m <- as.matrix(dtm)
  v <- sort(rowSums(m), decreasing = TRUE)
  d <- data.frame(word = names(v), freq = v)
  
  wordcloud(d$word, d$freq, colors = brewer.pal(9, "Set1"), random.order = FALSE, rot.per = 0)
  title(main = paste("Terrorists' Motives -", year), font.main = 1, col.main = "black", cex.main = 1.5)
}

# selected years
years <- c(2001:2020)

# Word clouds for each year
lapply(years, createWordCloud)
```

## Association Analysis

### Is there any association among attack, weapon and target?

#### Alluvial plots

```{r}
assoc2 <- GTD %>%
  filter(attacktype1_txt != "Unknown",
         weaptype1_txt != "Unknown",
         targtype1_txt != "Unknown",
         nkill >= 100,
         iyear >= 2001
         ) %>%
  mutate(
    # setting labels from "1" and "0"
    success = factor(success, labels = c("Succeeded", "Failed")),
    weaptype1_txt = case_when(
      weaptype1_txt == "Vehicle (not to include vehicle-borne explosives, i.e., car or truck bombs)" ~ "Vehicle",
      TRUE ~ weaptype1_txt)
  ) %>%
  select(success, region_txt, attacktype1_txt, weaptype1_txt, targtype1_txt, nkill) %>%
  ungroup()

```

```{r}
ggplot(assoc2,
       aes(y = nkill, axis1 = attacktype1_txt, axis2 = weaptype1_txt, axis3 = targtype1_txt)) +
  geom_alluvium(aes(fill = attacktype1_txt), width = 1/12) +
  geom_stratum(width = 1/12, fill = "black", color = "grey") +
  geom_label(stat = "stratum", 
            aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("attack", "weapon", "target"), expand = c(.15, .05)) +
  scale_fill_brewer(palette = "Set3") +
  ggtitle("parallel coord")+
  theme_minimal()+
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "grey"))
```

```{r}
ggplot(assoc2,
       aes(y = nkill, axis1 = attacktype1_txt, axis2 = targtype1_txt)) +
  geom_alluvium(aes(fill = attacktype1_txt), width = 1/12) +
  geom_stratum(width = 1/12, fill = "black", color = "grey") +
  geom_label(stat = "stratum", 
            aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("attack", "target"), expand = c(.15, .05)) +
  scale_fill_brewer(palette = "Set3") +
  ggtitle("parallel coord")+
  theme_minimal()+
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "grey"))
```


```{r}
pc <- ggplot(assoc2,
       aes(y = nkill, axis1 = attacktype1_txt, axis2 = weaptype1_txt, axis3 = targtype1_txt)) +
  geom_alluvium(aes(fill = attacktype1_txt), width = 1/12, curve_type = "quintic") +
  geom_stratum(width = 1/12, fill = "black", color = "grey") +
  geom_text(stat = "stratum", 
            aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("attack", "weapon", "target"), expand = c(.15, .05)) +
  scale_fill_brewer(palette = "Set3") +
  ggtitle("parallel coord")+
  theme_minimal()+
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "grey"))

ggplotly(pc)
```


#### Parallel Coordinates Plot

```{r}
pc <- ggparcoord(data = assoc2, 
           columns = c(2,3,4), 
           groupColumn = 1,
           scale = "uniminmax",
           alphaLines = 0.2,
           boxplot = TRUE, 
           title = "Parallel Coordinates Plot")

pc
```


```{r}
pstats <- GTD %>%
  filter(nkill > 50,
         iyear >= 2001,
         gname != "Unknown"
         ) %>%
  select(iyear, country_txt, region_txt, attacktype1_txt, weaptype1_txt, targtype1_txt, nkill) %>%
  ungroup()
```

## Statistical testing
### Is there a significant difference in casualities numbers across different regions?

Note: TBC. For terrorist groups, will need to clean up the values first.

```{r}
p1 <- ggbetweenstats(
  data = pstats,
  x = region_txt, 
  y = nkill,
  ylab = "Casualities", # label for y-axis
  xlab = "Region", # label for y-axis
  title = "Statistical significant difference in number of casualities among different regions",
  type = "np",
  palette = "Pastel1",
  messages = FALSE
)
p1
```

```{r}
ggplotly(p1)
```


### Is there a significant difference in casualities numbers based on the form of attacks?

```{r}
p2 <- ggbetweenstats(
  data = pstats,
  x = attacktype1_txt, 
  y = nkill,
  ylab = "Casualities", # label for y-axis
  xlab = "Region", # label for y-axis
  title = "Statistical significant difference in number of casualities among different attack types",
  type = "np",
  palette = "Pastel1",
  messages = FALSE
)
p2
```

==============================
CODES NOT IN USE
==============================
```{r}
attack <- GTD %>%
  filter(attacktype1_txt != "Unknown"
         ) %>%
  group_by(region_txt) %>%
  count(attacktype1_txt, name = "attack_count") %>%
  ungroup()


weapon <- GTD %>%
  filter(weaptype1_txt != "Unknown"
         ) %>%
  group_by(region_txt) %>%
  count(weaptype1_txt, name = "weapon_count") %>%
  ungroup()


target <- GTD %>%
  filter(targtype1_txt != "Unknown"
         ) %>%
  group_by(region_txt) %>%
  count(targtype1_txt, name = "target_count") %>%
  ungroup()


coord <- left_join(attack, weapon, by = "region_txt") %>%
  left_join(target, by = "region_txt")
```



## Network Analysis

use columns:
-   related (that shows eventid)
-   multiple
-   eventid
